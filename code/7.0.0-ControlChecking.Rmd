---
title: "Blank Control Analysis"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE)
# Loading library here
library(tidyverse)
library(extrafont)
# library(biomformat)
library(qiime2R)
library(phyloseq)
sessionInfo()
np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)
```

## Import
```{r}
# import metadata
mf <- read.delim("../data/processed-data/Metadata_Baby_Seeding_all_samples_final.txt", header = T, sep = "\t", na.strings = c("", "NA"), stringsAsFactors = F)

taxa_qza <- read_qza("../data/processed-data/taxonomy.qza")
taxa_tbl <- taxa_qza$data %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = T)
taxa_tbl$Domain[is.na(taxa_tbl$Domain)] <- "k_"
taxa_tbl$Phylum[is.na(taxa_tbl$Phylum)] <- "p_"
taxa_tbl$Class[is.na(taxa_tbl$Class)] <- "c_"
taxa_tbl$Order[is.na(taxa_tbl$Order)] <- "o_"
taxa_tbl$Family[is.na(taxa_tbl$Family)] <- "f_"
taxa_tbl$Genus[is.na(taxa_tbl$Genus)] <- "g_"
taxa_tbl$Species[is.na(taxa_tbl$Species)] <- "s_"

tree <- read_qza("../data/processed-data/tree.qza")
```
## Extracting blank control samples
1. Metadata
```{r}
BL = mf %>% filter(body_site_corrected=="Control" | is.na(body_site_corrected))

BL <- BL[BL$sample_name!="1718.11.14.I01.DM.800P", ] # remove the miss labeled stool samples (from diaper materials)
PC <- BL %>% filter(grepl("CONTROL A", orig_sampleid)) # these 2 are positive controls
BL <- BL %>% filter(!sample_name%in% PC$sample_name) # remove the 2 positive controls
BL <- BL[!(grepl("10894\\.CH|10894\\.NY", BL$sample_name) & is.na(BL$body_site_corrected)), ] # remove samplesBaby with no metadata info

Lib_blank_control <- BL %>% filter(grepl("dna|pcr|blank", sample_name, ignore.case = T) | grepl("dna|ext|pcr", orig_sampleid, ignore.case = T)) %>% mutate(Cat_control = "Lib_BL")
BL <- BL %>% filter(! sample_name %in% Lib_blank_control$sample_name) %>% mutate(Cat_control = "Field_BL")

BL_new <- rbind(Lib_blank_control, BL)
BL_new$seqcount[is.na(BL_new$seqcount)] <- 0
#write.table(BL_new, file = "../data/processed-data/Metadata_controls.txt", quote = F, sep = "\t", row.names = F)
```

2. Filter feature table to only include control samples
```{qiime}
qiime feature-table filter-samples \
    --i-table ../data/processed-data/table.qza \
    --m-metadata-file ../data/processed-data/Metadata_controls.txt \
    --o-filtered-table ../data/processed-data/table-controls.qza &
```

3. Import feature table with only control samples
```{r}
# filtered feature table contain only control samples
ft_qza <- read_qza("../data/processed-data/table-controls.qza")
## feature table in dataframe
ft_bl <- ft_qza$data %>% as.data.frame() %>% rownames_to_column(var = "OTU_ID") %>% filter(rowSums(.[,-1])!=0)

# actual sequencing count
seqcount <- ft_bl[, -1] %>% colSums()
## update BL_new seq count
BL_new$seqcount[match(names(seqcount), BL_new$sample_name)] <- seqcount
#BL_new$seqcount[!BL_new$sample_name %in% names(seqcount)]

## Metadata only with samples that have sequences
mt_ft_bl <- BL_new %>% filter(sample_name %in% colnames(ft_bl))
write.table(BL_new, file = "../data/processed-data/Metadata_controls.txt", quote = F, sep = "\t", row.names = F)
```

## Analysis of control samples alone
1. Check the sequencing depth of control samples
```{r}
ggplot(BL_new, aes(x = seqcount)) +
    geom_histogram() +
    facet_grid(.~Cat_control) +
    coord_cartesian(ylim = c(0,30))

split(BL_new, BL_new$Cat_control) %>% lapply(., function(x){stem(x$seqcount, scale = 4, width = 30)})

BL_new %>% mutate(ints = cut(seqcount, breaks = c(-1,1,seq(1000, 5000, by = 1000), 10000))) %>% group_by(Cat_control, ints) %>% summarise(N = n()) %>% mutate(Pct = N/sum(N)*100)
```

2. Check the ASV richness of control samples
```{r}
asv_ct <- ft_bl %>% summarise(across(mt_ft_bl$sample_name, ~sum(.x>0))) %>% t()
colnames(asv_ct) <- "ASV_ct"

asv_dat <- merge(asv_ct, BL_new, by.x = 0, by.y = 1, all.x  = T)

ggplot(asv_dat, aes(x = Cat_control, y = ASV_ct)) +
    geom_boxplot(outlier.shape = NA) +
    geom_point(aes(fill = seqcount), shape = 21, position = position_jitter(width = 0.2), size = 1, color = "grey") +
    scale_fill_gradientn(colours = c('#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'), values = scales::rescale(c(0, 5000)), limits = c(0, 7000), na.value = '#253494', breaks = c(0, 2000, 5000)) +
    scale_y_continuous(n.breaks = 20) +
    theme_bw() + theme(legend.position = "bottom", legend.box = "horizontal", aspect.ratio = 3) +
    labs(x = "", y = "Number of ASV", fill = "Sequences per sample", title = "Number of ASV per sample") +
    guides(fill = guide_colourbar(title.position = "top", title.hjust = 0.5))
ggsave("../results/check_control_2.pdf", width = 3.5, useDingbats = F)
```

3. Check the sequence count per ASVs
```{r}
ft_bl_l <- ft_bl %>% pivot_longer(-1, names_to = "sample_name", values_to = "seqcount") %>% filter(seqcount>0) %>% merge(., BL_new %>% select(sample_name, Cat_control), by = "sample_name", all.x = T) %>% group_by(OTU_ID) %>% mutate(Med_seq = median(seqcount)) %>% ungroup %>% arrange(Med_seq, OTU_ID)
ft_bl_l$OTU_ID = factor(ft_bl_l$OTU_ID, levels = ft_bl_l$OTU_ID %>% unique)

ggplot(ft_bl_l, aes(x = OTU_ID, y = seqcount)) +
    geom_point(aes(color = Cat_control), size = 0.5) +
    stat_summary(aes(group = 1), geom = "line", fun = median, size = 0.5) +
    theme_bw() + theme(axis.text.x = element_blank(), aspect.ratio = 0.3) +
    scale_y_continuous(trans = "log10", breaks = c(1, 5, 10, 100, 1000, 10000)) +
    labs(x = "Individual ASVs ordered by median sequence count across blank samples", y = "Sequence Count per ASV in each sample", color = "", title = "Number of sequences in each ASV in individual samples")
ggsave("../results/check_control_3.pdf", width = 9, useDingbats = F)

```

## Import samples feature tables
```{r}
# all body sites to use for now
ss <- c("Feces", "Mouth", "Forearm", "Vagina", "Right_Areola", "Nose")

# baby qza address
bb_qza_dirs <- paste0("../data/split-data/Baby-", ss[1:3])
# mom qza address
mm_qza_dirs <- paste0("../data/split-data/Mom-", ss)

# import qza tables
bb_qza <- parallel::mclapply(bb_qza_dirs, FUN = function(x){read_qza(paste0(x, "/table.qza"))}, mc.cores = np)
names(bb_qza) <- paste0("Baby-", ss[1:3])
#lapply(bb_qza, function(x){x$data %>% dim})

mm_qza <- parallel::mclapply(mm_qza_dirs, FUN = function(x){read_qza(paste0(x, "/table.qza"))}, mc.cores = np )
names(mm_qza) <- paste0("Mom-", ss)

#lapply(mm_qza, function(x){x$data %>% dim})


## extract metadata for to match the imported feature table
mt_ss <- mf %>% filter(sample_name %in% (sapply(c(bb_qza, mm_qza), FUN = function(x)colnames(x$data)) %>% unlist()))
mt_ss$body_site_corrected[mt_ss$body_site_corrected=="Right_Forearm"] = "Forearm"
```



## Compare controls with Samples
```{r, eval=FALSE}
# Control feature table and metadata
ft_bl
mt_ft_bl

# Sample feature table and metadata
bb_qza
mm_qza
mt_ss
```
1. Merge all things into a phyloseq object
```{r}
otu_bl <- otu_table(ft_bl %>% column_to_rownames(var = "OTU_ID"), taxa_are_rows = T)
otu_bbs <- parallel::mclapply(bb_qza, function(x){otu_table(x$data, taxa_are_rows = T)})
otu_mms <- parallel::mclapply(mm_qza, function(x){otu_table(x$data, taxa_are_rows = T)})
otu_all_lst <- c(list(otu_bl), otu_bbs, otu_mms)
names(otu_all_lst)[1] <- "BL"
for (i in seq(length(otu_all_lst))){
    if (i==1){
        otu_all = otu_all_lst[[i]]
    }
    otu_all = merge_phyloseq(otu_all, otu_all_lst[[i]])
}

mt_all <- plyr::rbind.fill(mt_ft_bl, mt_ss) %>% mutate(body_site_corrected = ifelse(!is.na(Cat_control), Cat_control, body_site_corrected), mom_baby = ifelse(!is.na(Cat_control), "Blanks", mom_baby)) %>% column_to_rownames(var = "sample_name") # merge the blank metadata with the feature metadata. The samples have NA in colume Cat_control

taxa_all <- taxa_tbl %>% filter(Feature.ID %in% rownames(otu_table(otu_all))) %>% select(Feature.ID, Domain:Species) %>% column_to_rownames(var = "Feature.ID") %>% as.matrix() %>% tax_table()

tree_all <- ape::keep.tip(tree$data, rownames(otu_table(otu_all)))

# this object have the otu table, taxa table, metadata and the phylogenetic tree
phylo_all <- merge_phyloseq(otu_all, taxa_all, sample_data(mt_all), tree_all)
saveRDS(phylo_all, file = "tmp_phyloseq_all.rds")
```


```{r}
# pick samples
#mt_all <- sample_data(phylo_all)
sample_bl <- mt_all %>% filter(!is.na(Cat_control)) %>% rownames()
set.seed(20)
sample_mom <- mt_all %>% filter(mom_baby=="Mom" & date_sampling_category_days_continuous<=30 & date_sampling_category_days_continuous>=0) %>% rownames() %>% sample(., 60)
sample_baby <- mt_all %>% filter(mom_baby=="Baby" & date_sampling_category_days_continuous<=30 & date_sampling_category_days_continuous>=7) %>% rownames() %>% sample(., 60)

phylo_filtered <- prune_samples(c(sample_bl, sample_mom, sample_baby), phylo_all)

# dist_bray <- distance(phylo_filtered, method = "bray")
# ord_bray <- ordinate(phylo_filtered, "PCoA", distance = dist_bray)

dist_jac <- distance(phylo_filtered, method = "jaccard", binary = T)
ord_jac <- ordinate(phylo_filtered, "PCoA", distance = dist_jac)

p <- plot_ordination(phylo_filtered, ord_jac)
col <- c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf')
names(col) <- c("Feces", "Field_BL", "Lib_BL", "Forearm", "Mouth", "Right_Areola", "Nose", "Vagina")

p1 <- ggplot(p$data, aes(Axis.1, Axis.2, color = body_site_corrected, shape = mom_baby)) +
    geom_point() +
    scale_color_manual(values = col) +
    stat_ellipse(aes(group = mom_baby, linetype = mom_baby)) +
    scale_shape_manual(values = c(1, 17, 16)) + 
    theme_bw(base_size = 10) + theme(aspect.ratio = 1) +
    labs(x = paste0("Axis.1 [", round(ord_jac$values$Relative_eig[1]*100,1), "%]"), y =paste0("Axis.2 [", round(ord_jac$values$Relative_eig[2]*100,1), "%]"))

p2 <- ggplot(p$data, aes(Axis.1, Axis.2, shape = mom_baby)) +
    geom_point(aes(fill = seqcount), size = 1, color = "grey") +
    scale_fill_gradientn(colours = c('#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'), values = scales::rescale(c(0, 5000)), limits = c(0, 7000), na.value = '#253494', breaks = c(0, 2000, 5000)) +
    stat_ellipse(aes(group = mom_baby, linetype = mom_baby)) +
    scale_shape_manual(values = c(21, 24, 22)) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1) +
    labs(x = paste0("Axis.1 [", round(ord_jac$values$Relative_eig[1]*100,1), "%]"), y =paste0("Axis.2 [", round(ord_jac$values$Relative_eig[2]*100,1), "%]")) +
    guides(linetype = F, shape = F)

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = 'bottom', legend.direction = "vertical")
ggsave(filename = "../results/controlvsamples_1.pdf", width = 7, useDingbats = F)
```

```{r}
mt_filterd_phylo <- sample_data(phylo_filtered) %>% as.matrix %>% as.data.frame() %>% rownames_to_column(var = "sample_name")

# dist of mother samples by site.
mt_filtered_phylo_mm <- mt_filterd_phylo %>% filter(mom_baby=="Mom")
dist_mm_by_site <- split(mt_filtered_phylo_mm, mt_filtered_phylo_mm$body_site_corrected) %>% lapply(., function(x){subset_dm_by_names(dist_jac, x$sample_name) %>% as.numeric})

dist_tbl <- lapply(seq_along(dist_mm_by_site), function(x){data.frame(distance = dist_mm_by_site[[x]], cat1 = names(dist_mm_by_site)[[x]], cat2 = "SampleRef")}) %>% do.call("rbind", .)


# dist of blanks within group 
mt_filtered_phylo_bl <- mt_filterd_phylo %>% filter(mom_baby=="Blanks")
dist_bl_by_site <- split(mt_filtered_phylo_bl, mt_filtered_phylo_bl$body_site_corrected) %>% lapply(., function(x){subset_dm_by_names(dist_jac, x$sample_name) %>% as.numeric})

dist_tbl <- rbind(dist_tbl, lapply(seq_along(dist_bl_by_site), function(x){data.frame(distance = dist_bl_by_site[[x]], cat1 = names(dist_bl_by_site)[[x]], cat2 = "Blanks")}) %>% do.call("rbind", .))


# dist of blanks vs samples
dist_blvSS <- (dist_jac %>% as.matrix())[mt_filtered_phylo_bl$sample_name, mt_filterd_phylo %>% filter(mom_baby!="Blanks") %>% pull(sample_name)] %>% as.data.frame() %>% rownames_to_column(var = "sample_name_bl") %>% pivot_longer(-1, names_to = "sample_name_ss", values_to = "distance") %>% arrange(sample_name_bl, distance) 

## select the 3 shortest distance for each sample
dist_blvSS_low <- dist_blvSS %>% group_by(sample_name_bl) %>% filter(distance<=distance[3]) %>% merge(., mt_filtered_phylo_bl, by.x = 1, by.y = 1)
dist_tbl_sub <- dist_blvSS_low %>% select(sample_name_bl, distance, body_site_corrected, seqcount, sample_name_ss) %>% merge(., mt_filterd_phylo %>% select(sample_name, mom_baby, body_site_corrected), by.x = "sample_name_ss", by.y = "sample_name", all.x = T) %>% rename(cat1 = body_site_corrected.x, ss_mom_baby = mom_baby, ss_body_site = body_site_corrected.y) %>% mutate(cat2 = "BlanksToSamples", seqcount = as.numeric(seqcount))
dist_tbl_sub2 <- dist_blvSS_low %>% select(sample_name_bl, distance, body_site_corrected, seqcount, sample_name_ss) %>% merge(., mt_filterd_phylo %>% select(sample_name, mom_baby, body_site_corrected), by.x = "sample_name_ss", by.y = "sample_name", all.x = T) %>% rename(cat1 = body_site_corrected.x, ss_mom_baby = mom_baby, ss_body_site = body_site_corrected.y) %>% mutate(cat2 = "BlanksToSamples", seqcount = as.numeric(seqcount)) %>% group_by(cat2, cat1, seqcount, sample_name_bl) %>% summarise(distance = mean(distance)) %>% ungroup()

#dist_tbl <- plyr::rbind.fill(dist_tbl, dist_tbl_sub %>% select(-c(1, 2))) %>% mutate(seqcount = as.numeric(seqcount))

p1 <- ggplot(dist_tbl, aes(cat2, distance)) +
    geom_point(position = position_jitter(), color = "grey50") +
    geom_boxplot(color = "blue", fill = NA, outlier.shape = NA) +
    theme_bw(base_size = 10) +theme(aspect.ratio = 1) + 
    labs(x = "")

p2 <- ggplot(dist_tbl_sub2, aes(seqcount, distance)) +
    geom_point(aes(fill= seqcount), color = "grey", shape = 21) +
    scale_fill_gradientn(colours = c('#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'), values = scales::rescale(c(0, 5000)), limits = c(0, 7000), na.value = '#253494', breaks = c(0, 2000, 5000)) +
    scale_x_continuous(trans = "log10") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.6)

p1 + p2 & coord_cartesian(ylim = c(0.5, 1))
scale_color_gradientn(colours = c('#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'), values = scales::rescale(c(0, 5000)), limits = c(0, 7000), na.value = '#253494', breaks = c(0, 2000, 5000))
ggsave(filename = "../results/controlvsamples_2.pdf", width = 9, useDingbats = F)

```

## Check taxa in controls
```{r, eval=FALSE}
# Control metadata
# phylo_all <- readRDS(file = "tmp_phyloseq_all.rds")
# mt_all <- sample_data(phylo_all)

mt_ft_bl <- mt_all %>% as.matrix() %>% as.data.frame() %>% filter(!is.na(Cat_control)) %>% rownames_to_column(var = "sample_name")
```
```{r}
phylo_bl <- prune_samples(mt_ft_bl$sample_name, phylo_all)


```


## functions
```{r}
subset_dm_by_names <- function(DM, Sname){
    # Extract the distance matrix using the sample names of a subset of the samples
    #
    # Args:
    #   DM: the distance matrix as a dist class
    #   Sname: a vector of the sample names
    #
    # Returns:
    #   The extracted distance matrix as a class dist object
    DM_mat <- DM %>% as.matrix
    DM_sname <- DM_mat %>% row.names()
    tmp <- match(Sname, DM_sname)
    Exist <- tmp[!is.na(tmp)]
    NoExist <- Sname[which(is.na(tmp))]
    print("Following samples do not exist in the distance matrix:")
    print(NoExist)
    DM <- DM_mat[Exist, Exist] %>% as.dist()
    return(DM)
}
```


## Recyled codes:
```{r}
# # taxonomy
# taxa_qza <- read_qza("../data/processed-data/taxonomy.qza")
# taxa_tbl <- taxa_qza$data %>% filter(Feature.ID %in% ft_bl$OTU_ID) %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = F)
# taxa_tbl$Domain[is.na(taxa_tbl$Domain)] <- "k_"
# taxa_tbl$Phylum[is.na(taxa_tbl$Phylum)] <- "p_"
# taxa_tbl$Class[is.na(taxa_tbl$Class)] <- "c_"
# taxa_tbl$Order[is.na(taxa_tbl$Order)] <- "o_"
# taxa_tbl$Family[is.na(taxa_tbl$Family)] <- "f_"
# taxa_tbl$Genus[is.na(taxa_tbl$Genus)] <- "g_"
# taxa_tbl$Species[is.na(taxa_tbl$Species)] <- "s_"
# 
# ft_w_taxa <- merge(taxa_tbl, ft_bl, by = 1)
# ft_glom <- list()
# for (tt in c("Genus", "Family", "Order", "Class", "Phylum", "Domain")){
#     ft_glom[[tt]] <- ft_w_taxa %>% group_by_at(vars("Domain":tt)) %>% summarise(across(mt_ft_bl$sample_name, sum, na.rm = T)) %>% ungroup()
# }
# ft_glom_df <- data.table::rbindlist(ft_glom, use.names = T, fill = T, idcol = "taxa.glom")
# #saveRDS(ft_glom_df, file = "tmp_ft_glom_df.Rds")
```

