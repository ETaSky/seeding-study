---
title: "Blank Control Analysis"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE)
# Loading library here
library(tidyverse)
library(extrafont)
# library(biomformat)
library(qiime2R)
sessionInfo()
np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)
```

## Import files
```{r}
# import metadata
mf <- read.delim("../data/processed-data/Metadata_Baby_Seeding_all_samples_final.txt", header = T, sep = "\t", na.strings = c("", "NA"), stringsAsFactors = F)
```


```{r}
BL = mf %>% filter(body_site_corrected=="Control" | is.na(body_site_corrected))

BL <- BL[BL$sample_name!="1718.11.14.I01.DM.800P", ] # remove the miss labeled stool samples (from diaper materials)
PC <- BL %>% filter(grepl("CONTROL A", orig_sampleid)) # these 2 are positive controls
BL <- BL %>% filter(!sample_name%in% PC$sample_name) # remove the 2 positive controls
BL <- BL[!(grepl("10894\\.CH|10894\\.NY", BL$sample_name) & is.na(BL$body_site_corrected)), ] # remove samplesBaby with no metadata info

Lib_blank_control <- BL %>% filter(grepl("dna|pcr|blank", sample_name, ignore.case = T) | grepl("dna|ext|pcr", orig_sampleid, ignore.case = T)) %>% mutate(Cat_control = "Lib_BL")
BL <- BL %>% filter(! sample_name %in% Lib_blank_control$sample_name) %>% mutate(Cat_control = "Field_BL")

BL_new <- rbind(Lib_blank_control, BL)
BL_new$seqcount[is.na(BL_new$seqcount)] <- 0

ggplot(BL_new, aes(x = seqcount, fill = )) +
    geom_histogram() +
    facet_grid(.~Cat_control) +
    coord_cartesian(ylim = c(0,30))

split(BL_new, BL_new$Cat_control) %>% lapply(., function(x){stem(x$seqcount, scale = 4, width = 30)})

BL_new %>% mutate(ints = cut(seqcount, breaks = c(-1,1,seq(1000, 5000, by = 1000), 10000))) %>% group_by(Cat_control, ints) %>% summarise(N = n()) %>% mutate(Pct = N/sum(N)*100)

write.table(BL_new, file = "../data/processed-data/Metadata_controls.txt", quote = F, sep = "\t", row.names = F)
```

```{qiime}
qiime feature-table filter-samples \
    --i-table ../data/processed-data/table.qza \
    --m-metadata-file ../data/processed-data/Metadata_controls.txt \
    --o-filtered-table ../data/processed-data/table-controls.qza &
```

```{r}
# filtered feature table contain only control samples
ft_qza <- read_qza("../data/processed-data/table-controls.qza")
## feature table in dataframe
ft_bl <- ft_qza$data %>% as.data.frame() %>% rownames_to_column(var = "OTU_ID") %>% filter(rowSums(.[,-1])!=0)

## Metadata only with samples that have sequences
mt_ft_bl <- BL_new %>% filter(sample_name %in% colnames(ft_bl)) 

# taxonomy
taxa_qza <- read_qza("../data/processed-data/taxonomy.qza")
taxa_tbl <- taxa_qza$data %>% filter(Feature.ID %in% ft_bl$OTU_ID) %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = F)
taxa_tbl$Domain[is.na(taxa_tbl$Domain)] <- "k_"
taxa_tbl$Phylum[is.na(taxa_tbl$Phylum)] <- "p_"
taxa_tbl$Class[is.na(taxa_tbl$Class)] <- "c_"
taxa_tbl$Order[is.na(taxa_tbl$Order)] <- "o_"
taxa_tbl$Family[is.na(taxa_tbl$Family)] <- "f_"
taxa_tbl$Genus[is.na(taxa_tbl$Genus)] <- "g_"
taxa_tbl$Species[is.na(taxa_tbl$Species)] <- "s_"

ft_w_taxa <- merge(taxa_tbl, ft_bl, by = 1)
ft_glom <- list()
for (tt in c("Genus", "Family", "Order", "Class", "Phylum", "Domain")){
    ft_glom[[tt]] <- ft_w_taxa %>% group_by_at(vars("Domain":tt)) %>% summarise(across(mt_ft_bl$sample_name, sum, na.rm = T)) %>% ungroup()
}
ft_glom_df <- data.table::rbindlist(ft_glom, use.names = T, fill = T, idcol = "taxa.glom")
saveRDS(ft_glom_df, file = "tmp_ft_glom_df.Rds")
```


