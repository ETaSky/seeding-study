---
title: "Source Tracking Analysis"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE)
# Loading library here
library(tidyverse)
library(extrafont)
# library(biomformat)
# library(ape)
# library(qiime2R)
library(phyloseq)
library(ComplexHeatmap)
sessionInfo()

np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)
```


## Pre-processing (no need to rerun)
### baby and maternal samples (rarefied tables)
```{r, eval=FALSE}
# all body sites to use for now
ss <- c("Feces", "Mouth", "Forearm", "Vagina", "Right_Areola", "Nose")

# baby qza address
bb_qza_dirs <- paste0("../data/split-data/Baby-", ss[1:3])
# mom qza address
mm_qza_dirs <- paste0("../data/split-data/Mom-", ss)

# import qza tables
bb_qza <- parallel::mclapply(bb_qza_dirs, FUN = function(x){read_qza(paste0(x, "/rarefy-table.qza"))}, mc.cores = np)
names(bb_qza) <- paste0("Baby-", ss[1:3])
#lapply(bb_qza, function(x){x$data %>% dim})

mm_qza <- parallel::mclapply(mm_qza_dirs, FUN = function(x){read_qza(paste0(x, "/rarefy-table.qza"))}, mc.cores = np )
names(mm_qza) <- paste0("Mom-", ss)

#lapply(mm_qza, function(x){x$data %>% dim})


# import metadata
mf <- read.delim("../data/processed-data/Metadata_Baby_Seeding_all_samples_final.txt", header = T, sep = "\t", na.strings = c("", "NA"), stringsAsFactors = F)
## extract metadata for
mf_ss <- mf %>% filter(sample_name %in% (sapply(c(bb_qza, mm_qza), FUN = function(x)colnames(x$data)) %>% unlist()))
mf_ss$body_site_corrected[mf_ss$body_site_corrected=="Right_Forearm"] = "Forearm"
```

### Gauze samples (this needs to be udpated once uploading gauze sequences into qiita)
```{r, eval=FALSE}
ft_qza_all <- read_qza("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/3-deblur/SA-P1-P3_deblur_no-mitochondria-no-chloroplast_table.qza")
mf_gauze <- read.table("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/0-Doc/Mapping_baby_seeding_gauze.txt", header = T, sep = "\t")
ft_tbl_gauze <- ft_qza_all$data[, mf_gauze$sample_name] %>% as.data.frame %>% filter(rowSums(.)>0)
```

### Create phyloseq object
```{r, eval=FALSE}
otu_ss <- parallel::mclapply(c(bb_qza, mm_qza), function(x){otu_table(x$data %>% as.data.frame %>% select(any_of(mf_ss$sample_name)) %>% filter(rowSums(.)>0), taxa_are_rows = T)}, mc.cores = np)

## import the otu table into phyloseq
otu_ss_phylo <- do.call("merge_phyloseq", otu_ss)

taxa_qza <- read_qza("../data/processed-data/taxonomy.qza")
taxa_tbl <- taxa_qza$data %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = T)
taxa_tbl$Domain[is.na(taxa_tbl$Domain)] <- "k_"
taxa_tbl$Phylum[is.na(taxa_tbl$Phylum)] <- "p_"
taxa_tbl$Class[is.na(taxa_tbl$Class)] <- "c_"
taxa_tbl$Order[is.na(taxa_tbl$Order)] <- "o_"
taxa_tbl$Family[is.na(taxa_tbl$Family)] <- "f_"
taxa_tbl$Genus[is.na(taxa_tbl$Genus)] <- "g_"
taxa_tbl$Species[is.na(taxa_tbl$Species)] <- "s_"

taxa_all <- taxa_tbl %>% filter(Feature.ID %in% rownames(otu_table(otu_ss_phylo))) %>% select(Feature.ID, Domain:Species) %>% column_to_rownames(var = "Feature.ID") %>% as.matrix() %>% tax_table()

ss_phylo <- merge_phyloseq(otu_ss_phylo, taxa_all, sample_data(mf_ss %>% column_to_rownames(var = "sample_name")))


taxa_qza_gauze <- read_qza("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/3-deblur/taxonomy_gg13_8.qza")
taxa_gauze_tbl <- taxa_qza_gauze$data %>% filter(Feature.ID %in% rownames(ft_tbl_gauze)) %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = T)
taxa_gauze_tbl$Domain[is.na(taxa_gauze_tbl$Domain)] <- "k_"
taxa_gauze_tbl$Phylum[is.na(taxa_gauze_tbl$Phylum)] <- "p_"
taxa_gauze_tbl$Class[is.na(taxa_gauze_tbl$Class)] <- "c_"
taxa_gauze_tbl$Order[is.na(taxa_gauze_tbl$Order)] <- "o_"
taxa_gauze_tbl$Family[is.na(taxa_gauze_tbl$Family)] <- "f_"
taxa_gauze_tbl$Genus[is.na(taxa_gauze_tbl$Genus)] <- "g_"
taxa_gauze_tbl$Species[is.na(taxa_gauze_tbl$Species)] <- "s_"
taxa_gauze_tbl <- taxa_gauze_tbl %>% select(Feature.ID, Domain:Species) %>% column_to_rownames(var = "Feature.ID") %>% as.matrix() %>% tax_table()

phylo_gauze <- merge_phyloseq(otu_table(ft_tbl_gauze, taxa_are_rows = T), taxa_gauze_tbl, sample_data(mf_gauze %>% column_to_rownames(var = "sample_name")))
phylo_gauze_5k <- rarefy_even_depth(phylo_gauze, sample.size = 5000, rngseed = 20, replace = F, trimOTUs = T)

phylo_wk <- merge_phyloseq(ss_phylo, phylo_gauze_5k) %>% prune_taxa(taxa_sums(.)>0, .)
saveRDS(phylo_wk, file = "tmp_phylo_wk_transmission.Rdata")
```
## Analysis
```{r}
ss <- c("Feces", "Mouth", "Forearm", "Vagina", "Right_Areola", "Nose")

phylo_wk = readRDS("tmp_phylo_wk_transmission.Rdata")
mf_wk <- sample_data(phylo_wk) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "sample_name")


## Maternal ASV paranatal
mf_mm_day0 <- mf_wk %>% filter(mom_baby=="Mom", as.numeric(date_sampling_category_days_continuous)==0)

otu_mm_day0 <- prune_samples(mf_mm_day0$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.)) # only include otu existed in more than 10% of samples

## Baby ASVs
mf_bb_lst <- mf_wk %>% filter(mom_baby=="Baby") %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
otu_baby_lst <- parallel::mclapply(mf_bb_lst, function(x){prune_samples(x$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.))}, mc.cores = np)



for (ss_m in ss){
    #ss_m = ss[1]
    for (ss_b in ss[1:3]){
        #ss_b = ss[1]
        # select mother samples
        mf_mm_tmp <- mf_mm_day0 %>% filter(body_site_corrected==ss_m)
        otu_mm_tmp <- otu_mm_day0 %>% select(mf_mm_tmp$sample_name) %>% filter(rowSums(.)>0)
        
        # select baby samples
        mf_bb_tmp <- mf_wk %>% filter(mom_baby=="Baby", body_site_corrected==ss_b)
        otu_bb_tmp <- otu_baby_lst[grepl(ss_b, names(otu_baby_lst))]
        
        otu_bb_all <- lapply(otu_bb_tmp, rownames) %>% do.call("c", .) %>% unique # all otu from babies, regardless birth mode
        
        otu_cc <- intersect(rownames(otu_mm_tmp), otu_bb_all) # common otu between maternal and baby samples
        
        # Vag babies
        function(birthmode, ){
            bm = birthmode # the string of birth mode, ["CS", "Vag", "CSseed"]
            mf_bb_tmp1 <- mf_bb_tmp %>% filter(sample_name %in% colnames(otu_bb_tmp[[paste(ss_b, bm, sep = ".")]])) %>% arrange(as.numeric(date_sampling_category_days_continuous))
        
        ## create the matrix for heatmap
        otu_mat1 <- otu_mm_tmp[otu_cc, ] %>% merge(., otu_bb_tmp[[paste(ss_b, bm, sep = ".")]][, mf_bb_tmp1$sample_name], by = 0, all.x = T) %>% column_to_rownames(var = "Row.names")
        ### convert to log scale
        otu_mat1 = log10(otu_mat1/5000)
        ### convert na or Inf to be -5, a value that is beyond the actual data range
        otu_mat1[otu_mat1==-Inf] = -5
        otu_mat1[is.na(otu_mat1)] = -5
        
        ## create the cluster for dendrogram of ASV based on baby samples only if it is Vag
        if (bm=="Vag"){
            asv_cluster <- hclust(dist(otu_mat1[,  mf_bb_tmp1$sample_name]))
            row_cluster <- asv_cluster
        } else {
            
        }
        
        
        ## metadata for the heatmap
        meta_mat1 <- rbind(mf_mm_tmp, mf_bb_tmp1)
        ## data table for column annotation
        df_col <- meta_mat1 %>% ungroup %>% select(mom_baby, date_sampling_category_days_continuous) %>% 
            mutate(mom_baby = factor(mom_baby, levels = c("Mom", "Baby")),
                   date_sampling_category_days_continuous = as.numeric(date_sampling_category_days_continuous),
                   Days = case_when(date_sampling_category_days_continuous<=7 ~ "0-7",
                                    date_sampling_category_days_continuous<=30 ~ "14-30",
                                    date_sampling_category_days_continuous>=240 ~ ">=240",
                                    T ~ as.character(date_sampling_category_days_continuous)),
                   Days =  factor(Days, levels = c("0-7","14-30","60","90","120","150","180","210",">=240")),
                   date_sampling_category_days_continuous = NULL)
        
        ## color scheme for the heatmap cells
        mat_col_fun = circlize::colorRamp2(c(-5, -4, -3.3, -2.6, -1.9, -1.2, -0.5), c("grey60","#253494", "#2c7fb8", "#41b6c4", "#7fcdbb", "#c7e9b4", "#ffffcc"))
       
        Days_col = c('#fff7f3','#fde0dd','#fcc5c0','#fa9fb5','#f768a1','#dd3497','#ae017e','#7a0177','#49006a')
        names(Days_col) <- df_col$Days %>% unique
        
        col_ha1 = columnAnnotation(mom_baby = df_col$mom_baby, col = list(mom_baby=c("Mom" = '#fdcdac', "Baby" = '#b3e2cd')), show_annotation_name = F,
                                   Days = anno_block(gp = gpar(fill = Days_col), labels = names(Days_col), labels_gp = gpar(col = "black", fontsize = 6)),
                                   annotation_name_gp = gpar(fontsize = 7), 
                                   annotation_legend_param = list(mom_baby = list(labels_gp = gpar(fontsize = 7), title_gp = gpar(fontsize = 7, fontface = "bold"))))
        p1 <- Heatmap(otu_mat1, 
                      
                      name = "Relative abundance",
                      heatmap_legend_param = list(at = c(-4, -3.3, -2.6, -1.9, -1.2, -0.5), labels = c("0.01%", "0.05%", "0.25%", "1.25%", "6.25%", "31.25%"),
                                                  labels_gp = gpar(fontsize = 6), title_gp = gpar(fontsize = 7, fontface = "bold")),
                      
                      column_title = paste0("Mom.", ss_m, " vs VagBabies.", ss_b),
                      
                      cluster_rows = asv_cluster,
                      cluster_columns = F,
                      show_column_names = F,
                      show_row_names = F,
                      row_dend_reorder = T,
                      
                      col = mat_col_fun,
                      
                      top_annotation = col_ha1,
                      
                      row_dend_width = unit(15, "mm"),
                      
                      column_split = df_col$Days,
                      #column_title = NULL,
                      column_gap = unit(rep(0, 8), "mm"),
                      cluster_column_slices = F,
                      
                      height = unit(7/.pt, "mm")*dim(otu_mat1)[1],
                      width = unit(0.7/.pt, "mm")*dim(otu_mat1)[2])
        draw(p1)
        }
        
        
        
        # CSseed babies
        
    }
}

```

