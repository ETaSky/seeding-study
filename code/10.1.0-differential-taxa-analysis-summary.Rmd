---
title: "Differential taxa analysis"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, 
                      warning = FALSE, message = FALSE)
# Loading library here
library(conflicted)
library(tidyverse)
library(extrafont)
library(Ternary)
library(colorspace)
sessionInfo()
conflict_prefer("filter", "dplyr")

np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)

fig_path = "tmp_figs/"

col_birthmode = c("#377EB8", "#4DAF4A", "#E41A1C")
names(col_birthmode) = c("Vag", "CSseed", "CS")
```
## Summarizing songbird resulst
```{r}
songbird <- read.csv("../data/diff-analysis-new/Songbird-final.tsv", 
                     sep = "\t", fill = F)
songbird_wk <- songbird %>% 
    select(body_site_days, featureid, 
           starts_with("P."), Taxon, 
           C.birth_mode_ms..Treatment..Vag....T.CS., 
           C.birth_mode_ms..Treatment..Vag....T.CSseed., 
           feature.frequency, seeding.effectiveness) %>%
    rename(P.VD = P.Vaginal., P.CSR = P.CS.seeded., P.CS = P.CS., 
           Diff.CS = C.birth_mode_ms..Treatment..Vag....T.CS.,
           Diff.CSR = C.birth_mode_ms..Treatment..Vag....T.CSseed.) %>%
    separate(body_site_days, into = c(NA, "body_site", "days"), sep = "-") %>% 
    mutate(days = as.numeric(days)) %>%
    group_by(body_site, days) %>% 
    mutate(seeding.effectiveness.scale = pnorm(as.numeric(scale(seeding.effectiveness, center = mean(seeding.effectiveness), scale = T)))) %>%
    ungroup() %>%
    arrange(body_site, days, desc(seeding.effectiveness.scale)) %>%
    mutate(featureid = factor(featureid, levels = unique(featureid)), 
           Taxon = gsub(" ", "", Taxon),
           Taxon = gsub("__", "_", Taxon)) %>%
    separate(Taxon, into = c("k", "p", "c", "o", "f", "g", "s"), sep = ";",
             remove = F,
             fill = "right") %>%
    mutate(across(k:s, ~ifelse(is.na(.x), "-", .x)))

# check the distribution of seeding-effectiveness score
ggplot(songbird_wk, ggplot2::aes(x = seeding.effectiveness)) +
    geom_histogram(ggplot2::aes(color = as.factor(days), fill = as.factor(days)), alpha = 0.3, position = "identity") +
    facet_grid(body_site ~ .)

songbird_wk %>% group_by(body_site, days) %>% summarise(stats = Hmisc::smean.sd(seeding.effectiveness) %>% paste(collapse = "--"))


songbird_wk_0.9 <- songbird_wk %>% 
    filter(seeding.effectiveness.scale>=0.9, feature.frequency>=0.1) %>%
    mutate(across(.cols = c(P.CS:P.VD, feature.frequency:seeding.effectiveness.scale), ~round(., 3)))

songbird_wk_0.9 %>% pivot_wider(id_cols = c(body_site, days, Taxon, k:s), names_from = NULL, values_from = c(Diff.CS, Diff.CSR, seeding.effectiveness.scale, feature.frequency, P.VD, P.CSR, P.CS), names_repair = "minimal") %>% arrange(body_site, days, Taxon) %>% View

songbird_wk_0.8 <- songbird_wk %>% 
    filter(seeding.effectiveness.scale>=0.8, feature.frequency>=0.1) %>%
    mutate(across(.cols = c(P.CS:P.VD, feature.frequency:seeding.effectiveness.scale), ~round(., 3)))

songbird_wk_0.8 %>% group_by(body_site, days) %>% summarize(N = n())

```
### Ternary plot
```{r}
bb = "Feces"
pdf(file = paste0(fig_path, "songbird_ternary_plot_", bb, ".pdf"),
    width = 7, height = 10, useDingbats = F)
par(mfrow = c(2, 2), mar = rep(0.1, 4))

plot_ternary = function(bb, dd){
    TernaryPlot(point = "up",  alab = "Cesaren-seeded <---", 
                blab = "Vaginal --->", clab = "Cesarean <---",
                lab.col = c( "#4DAF4A", "#377EB8", "#E41A1C"),
                
                grid.minor.lines = 0,
                grid.col = c( "#4DAF4A", "#377EB8", "#E41A1C"),
                grid.lty = "dotted",
                
                padding = 0,
                
                axis.col = "black",
                axis.labels=seq(0, 1, by = 0.1),
                
                clockwise = F)
    dat_ternary = songbird_wk %>% filter(body_site==bb, days==dd) %>% 
        select(P.CSR, P.VD, P.CS, seeding.effectiveness.scale)
    dat_ternary$col = circlize::colorRamp2(seq(0, 1, 0.1), colors = divergingx_hcl(11, palette = "Tropic"))(dat_ternary$seeding.effectiveness.scale)
    
    AddToTernary(points, dat_ternary[, 1:3], pch = 21, cex = 0.7,
                 bg = dat_ternary$col)
}

p1 <- as.ggplot(function() plot_ternary(bb, 2)) + coord_fixed() +
    theme_void(base_size = 10) + theme(plot.margin = margin(0,0,0,0),
                                       plot.background = element_rect(color = "black"))
p1
p2 <- as.grob(function() plot_ternary(bb, 30))
plot_grid(p1, p2)

ggplot(data.frame(x = seq(0, 1, length.out = 100), y = 1), aes(x = x, y = y, fill = x-0.5)) +
    geom_raster(show.legend = F) +
    theme_minimal() + theme(axis.ticks.length.x = unit(-0.5, "cm"), axis.ticks.x = element_line(color = "black")) +
    scale_fill_continuous_divergingx(palette = "Tropic") +
    scale_x_continuous(breaks = seq(0.1, 0.9, 0.2))



```
### Plot against differentials
```{r}
bb = "Feces"
load("tmp_all_phylo.Rdata")

songbird_wk2 <- songbird_wk %>%
    filter(feature.frequency>=0.1, p!="p_", c!="c_", o!="o_", f!="f_",
           p!="-", c!="-", o!="-", f!="-")


for (dd in c(2, 30, 120, 180)){
    #dd=2
    dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
        mutate(x = paste(p, c, o, f, g, sep = ";"))
    dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
        transform_sample_counts(., function(x){x / sum(x)}) %>%
        otu_table() %>% as.matrix() %>% as.data.frame() %>%
        rownames_to_column(var = "ASV") %>%
        filter(ASV %in% dat$featureid) %>% 
        pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
        filter(rel_a>0) %>%
        merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
    
    x.order = dat %>% group_by(x, featureid) %>% summarise(MM = mean(Diff.CS)) %>% arrange(desc(MM))
    
    p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = -Diff.CS)) +
        ggplot::annotate("rect", ymin = -Inf, ymax = 0, xmin = -Inf, xmax = Inf, fill = "#E41A1C", alpha = 0.1) +
        ggplot::annotate("rect", ymin = 0, ymax = Inf, xmin = -Inf, xmax = Inf, fill = "#377EB8", alpha = 0.1) +
        geom_hline(yintercept = 0, color = "grey") +
        geom_point(ggplot::aes(fill = seeding.effectiveness.scale), 
                   shape = 21, color = "black", size = 1.5) +
        scale_fill_distiller(palette = 'RdYlBu', direction = 1) +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = expression(Songbird~differentials~log~frac(Vag, CS)), fill = "Seeding Efficacy", title = paste0("Day", dd))
    p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = rel_a)) +
        geom_boxplot(outlier.size = 1) +
        scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), labels =c("0.01%", "0.1%", "1%", "10%", "100%"), trans = "log10") +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = "Relative Abundance in log scale", title = paste0("Day", dd))
    
    p3 = p + p2 + theme(axis.text.y = element_blank(), title = element_blank())
    print(p3)
    set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_diff_", bb, "_g_day", dd, ".pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/156, "in"), useDingbats = F )
}

## filter by seeding effectiveness
for (dd in c(2, 30, 120, 180)){
    #dd=2
    dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
        mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
        group_by(k, p, c, o, f, g) %>%
        filter(any(seeding.effectiveness.scale>=0.8))
    dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
        transform_sample_counts(., function(x){x / sum(x)}) %>%
        otu_table() %>% as.matrix() %>% as.data.frame() %>%
        rownames_to_column(var = "ASV") %>%
        filter(ASV %in% dat$featureid) %>% 
        pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
        filter(rel_a>0) %>%
        merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
    
    x.order = dat %>% group_by(x, featureid) %>% summarise(MM = mean(Diff.CS)) %>% arrange(desc(MM))
    
    p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = -Diff.CS)) +
        ggplot::annotate("rect", ymin = -Inf, ymax = 0, xmin = -Inf, xmax = Inf, fill = "#E41A1C", alpha = 0.1) +
        ggplot::annotate("rect", ymin = 0, ymax = Inf, xmin = -Inf, xmax = Inf, fill = "#377EB8", alpha = 0.1) +
        geom_hline(yintercept = 0, color = "grey") +
        geom_point(ggplot::aes(fill = seeding.effectiveness.scale), 
                   shape = 21, color = "black", size = 1.5) +
        scale_fill_distiller(palette = 'RdYlBu', direction = 1) +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = expression(Songbird~differentials~log~frac(Vag, CS)), fill = "Seeding Efficacy", title = paste0("Day", dd))
    p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = rel_a)) +
        geom_boxplot(outlier.size = 1) +
        scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), labels =c("0.01%", "0.1%", "1%", "10%", "100%"), trans = "log10") +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = "Relative Abundance in log scale", title = paste0("Day", dd))
    
    p3 = p + p2 + theme(axis.text.y = element_blank(), title = element_blank())
    print(p3)
    set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_diff_", bb, "_g_day", dd, "_v0.8.pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/156, "in"), useDingbats = F )
}
```

### Plot against P.CS
```{r}

for (dd in c(2, 30, 120, 180)){
    #dd=2
    dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
        mutate(x = paste(p, c, o, f, g, sep = ";"))
    print(nrow(dat))
    next
    dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
        transform_sample_counts(., function(x){x / sum(x)}) %>%
        otu_table() %>% as.matrix() %>% as.data.frame() %>%
        rownames_to_column(var = "ASV") %>%
        filter(ASV %in% dat$featureid) %>% 
        pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
        filter(rel_a>0) %>%
        merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
    
    x.order = dat %>% group_by(x, featureid) %>% summarise(MM = mean(P.CS)) %>% arrange(desc(MM))
    
    p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = P.CS)) +
        ggplot::annotate("rect", ymin = 0.75, ymax = 1, xmin = -Inf, xmax = Inf, fill = "#E41A1C", alpha = 0.1) +
        ggplot::annotate("rect", ymin = 0, ymax = 0.25, xmin = -Inf, xmax = Inf, fill = "#377EB8", alpha = 0.1) +
        geom_point(ggplot::aes(fill = seeding.effectiveness.scale), 
                   shape = 21, color = "black", size = 1.5) +
        scale_fill_distiller(palette = 'RdYlBu', direction = 1) +
        scale_y_continuous(position = "right") +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = "Relative probality in cesarean", fill = "Seeding Efficacy", title = paste0("Day", dd))
    p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = rel_a)) +
        geom_boxplot(outlier.size = 1) +
        scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), labels =c("0.01%", "0.1%", "1%", "10%", "100%"), trans = "log10", position = "right") +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = "Relative Abundance in log scale", title = paste0("Day", dd))
    
    p3 = p + p2 + theme(axis.text.y = element_blank(), title = element_blank())
    print(p3)
    set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_diff_", bb, "_g_day", dd, "_v3.pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/156, "in"), useDingbats = F )
}

```

```{r}
for (dd in c(2, 30, 120, 180)){
    #dd=2
    dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd, abs(Diff.CS)>=0.7) %>%
        mutate(x = paste(p, c, o, f, g, sep = ";"))
    #print(nrow(dat))
    #next
    dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
        transform_sample_counts(., function(x){x / sum(x)}) %>%
        otu_table() %>% as.matrix() %>% as.data.frame() %>%
        rownames_to_column(var = "ASV") %>%
        filter(ASV %in% dat$featureid) %>% 
        pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
        filter(rel_a>0) %>%
        merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
    
    x.order = dat %>% group_by(x, featureid) %>% summarise(MM = mean(P.CS)) %>% arrange(desc(MM))
    
    p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = P.CS)) +
        ggplot::annotate("rect", ymin = 0.75, ymax = 1, xmin = -Inf, xmax = Inf, fill = "#E41A1C", alpha = 0.1) +
        ggplot::annotate("rect", ymin = 0, ymax = 0.25, xmin = -Inf, xmax = Inf, fill = "#377EB8", alpha = 0.1) +
        geom_point(ggplot::aes(fill = seeding.effectiveness.scale), 
                   shape = 21, color = "black", size = 1.5) +
        scale_fill_distiller(palette = 'RdYlBu', direction = 1) +
        scale_y_continuous(position = "right") +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = "Relative probality in cesarean", fill = "Seeding Efficacy", title = paste0("Day", dd))
    p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(ggplot2::aes(x = x, y = rel_a)) +
        geom_boxplot(outlier.size = 1) +
        scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), labels =c("0.01%", "0.1%", "1%", "10%", "100%"), trans = "log10", position = "right") +
        ggplot2::coord_flip() +
        ggplot2::theme_bw() +
        labs(x = "", y = "Relative Abundance in log scale", title = paste0("Day", dd))
    
    p3 = p + p2 + theme(axis.text.y = element_blank(), title = element_blank())
    print(p3)
    set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_diff_", bb, "_g_day", dd, "_v4.pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/156, "in"), useDingbats = F )
}

```


## Summarizing ANCOM results
```{r}
dat_path = list.files(path = "../data/diff-analysis-new/ancom_all_results",
                     pattern = "*rds", full.names = T, include.dirs = F)

dat_nms <- (dat_path %>% str_split(., "/|\\.", simplify = T))[, 7]
dat_files <- lapply(dat_path, function(x){readRDS(x)})
names(dat_files) <- dat_nms

dat_flt <- lapply(dat_files, function(x){lapply(x, function(y){y$W.taxa %>% filter(detected_0.6==T)}) %>% 
        do.call("rbind", .) %>% 
        rownames_to_column(var = "body_site_days")}) %>% 
    do.call("rbind", .) %>%
    rownames_to_column(var = "level") %>%
    separate(level, into = c(NA, NA, "level", NA), sep = "_|\\.") %>%
    separate(body_site_days, into = c(NA, "body_sites", "days", NA, NA), sep = "-|\\.") %>%
    mutate(days = as.numeric(days))
```

```{r}
load("tmp_all_phylo.Rdata")
levels = dat_flt$level %>% unique
bodysites = dat_flt$body_sites %>% unique
timepoints = dat_flt$days %>% unique
for (ll in levels){
    for (bb in bodysites){
        for (tt in timepoints){
            dat = dat_flt %>% filter(level==ll, body_sites==bb, days==tt)
            dat_phylo = all_phylo[[ll]][[paste0("Baby-", bb, "-", tt, ".0")]] %>%
                prune_taxa(dat$Taxa_id, x = .) %>% 
                transform_sample_counts(., function(x){x / sum(x)})
            mf_phylo = sample_data(dat_phylo) %>% as.matrix() %>% as.data.frame() %>%
                rownames_to_column(var = "sample_name") %>%
                arrange(birth_mode_ms)
            plot_heatmap(dat_phylo, 
                         sample.label = "birth_mode_ms",
                         sample.order = mf_phylo$sample_name,
                         method = NULL, 
                         distance = NULL) %>% print()
        }
    }
}
```


