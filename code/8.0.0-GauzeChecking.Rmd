---
title: "8.0.0-GauzeAnalysis"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE)
# Loading library here
library(tidyverse)
library(extrafont)
# library(biomformat)
library(qiime2R)
library(phyloseq)
library(patchwork)
library(VennDiagram)
library(rstatix)
sessionInfo()
np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)
```

## Import (no need to run)
### Import sample data 
```{r, eval=FALSE}
mf <- read.delim("../data/processed-data/Metadata_Baby_Seeding_all_samples_final.txt", header = T, sep = "\t", na.strings = c("", "NA"), stringsAsFactors = F)

# all body sites to use for now
ss <- c("Feces", "Mouth", "Forearm", "Vagina", "Right_Areola", "Nose")

# baby qza address
bb_qza_dirs <- paste0("../data/split-data/Baby-", ss[1])
# mom qza address
mm_qza_dirs <- paste0("../data/split-data/Mom-", ss)

# import qza tables
bb_qza <- parallel::mclapply(bb_qza_dirs, FUN = function(x){read_qza(paste0(x, "/table.qza"))}, mc.cores = np)
names(bb_qza) <- paste0("Baby-", ss[1])
#lapply(bb_qza, function(x){x$data %>% dim})

mm_qza <- parallel::mclapply(mm_qza_dirs, FUN = function(x){read_qza(paste0(x, "/table.qza"))}, mc.cores = np )
names(mm_qza) <- paste0("Mom-", ss)

#lapply(mm_qza, function(x){x$data %>% dim})


## extract metadata for to only include samples in 1st week
mt_ss <- mf %>% filter(sample_name %in% (sapply(c(bb_qza, mm_qza), FUN = function(x)colnames(x$data)) %>% unlist())) %>% filter(as.numeric(date_sampling_category_days_continuous)<=7, as.numeric(date_sampling_category_days_continuous)>=0)
mt_ss$body_site_corrected[mt_ss$body_site_corrected=="Right_Forearm"] = "Forearm"
```

```{r, eval=FALSE}
## import the data from the body site of interest
otu_ss <- parallel::mclapply(c(bb_qza, mm_qza), function(x){otu_table(x$data %>% as.data.frame %>% select(any_of(mt_ss$sample_name)) %>% filter(rowSums(.)>0), taxa_are_rows = T)}, mc.cores = np)

## import the otu table into phyloseq
otu_ss_phylo <- do.call("merge_phyloseq", otu_ss)

taxa_qza <- read_qza("../data/processed-data/taxonomy.qza")
taxa_tbl <- taxa_qza$data %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = T)
taxa_tbl$Domain[is.na(taxa_tbl$Domain)] <- "k_"
taxa_tbl$Phylum[is.na(taxa_tbl$Phylum)] <- "p_"
taxa_tbl$Class[is.na(taxa_tbl$Class)] <- "c_"
taxa_tbl$Order[is.na(taxa_tbl$Order)] <- "o_"
taxa_tbl$Family[is.na(taxa_tbl$Family)] <- "f_"
taxa_tbl$Genus[is.na(taxa_tbl$Genus)] <- "g_"
taxa_tbl$Species[is.na(taxa_tbl$Species)] <- "s_"

taxa_all <- taxa_tbl %>% filter(Feature.ID %in% rownames(otu_table(otu_ss_phylo))) %>% select(Feature.ID, Domain:Species) %>% column_to_rownames(var = "Feature.ID") %>% as.matrix() %>% tax_table()

ss_phylo <- merge_phyloseq(otu_ss_phylo, taxa_all, sample_data(mt_ss %>% column_to_rownames(var = "sample_name")))
```

### Import gauze seq
This section needs to be updated once seqs are uploaded into qiita
```{r, eval=FALSE}
mt_gauze <- read.table("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/0-Doc/Mapping_baby_seeding_gauze.txt", header = T, sep = "\t") %>% column_to_rownames(var = "sample_name")

ft_qza_all <- read_qza("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/3-deblur/SA-P1-P3_deblur_no-mitochondria-no-chloroplast_table.qza")
ft_tbl_gauze <- ft_qza_all$data[, rownames(mt_gauze)] %>% as.data.frame %>% filter(rowSums(.)>0)

# tree_qza_gauze <- read_qza("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/3-deblur/sepp_tree/tree.qza")
# tree_gauze <- ape::keep.tip(tree_qza_gauze$data, rownames(ft_tbl_gauze))

taxa_qza_gauze <- read_qza("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/3-deblur/taxonomy_gg13_8.qza")
taxa_gauze_tbl <- taxa_qza_gauze$data %>% filter(Feature.ID %in% rownames(ft_tbl_gauze)) %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = T)
taxa_gauze_tbl$Domain[is.na(taxa_gauze_tbl$Domain)] <- "k_"
taxa_gauze_tbl$Phylum[is.na(taxa_gauze_tbl$Phylum)] <- "p_"
taxa_gauze_tbl$Class[is.na(taxa_gauze_tbl$Class)] <- "c_"
taxa_gauze_tbl$Order[is.na(taxa_gauze_tbl$Order)] <- "o_"
taxa_gauze_tbl$Family[is.na(taxa_gauze_tbl$Family)] <- "f_"
taxa_gauze_tbl$Genus[is.na(taxa_gauze_tbl$Genus)] <- "g_"
taxa_gauze_tbl$Species[is.na(taxa_gauze_tbl$Species)] <- "s_"
taxa_gauze_tbl <- taxa_gauze_tbl %>% select(Feature.ID, Domain:Species) %>% column_to_rownames(var = "Feature.ID") %>% as.matrix() %>% tax_table()

phylo_gauze <- merge_phyloseq(otu_table(ft_tbl_gauze, taxa_are_rows = T), taxa_gauze_tbl, sample_data(mt_gauze))

phylo_gauze_dat <- merge_phyloseq(phylo_gauze, ss_phylo) %>% prune_taxa(taxa_sums(.)>0, .)
saveRDS(phylo_gauze_dat, file = "phylo_gauze_dataset.rds")
```


## Analysis
```{r}
phylo_gauze_dat <- readRDS("phylo_gauze_dataset.rds")
mt_gauze_dat <- sample_data(phylo_gauze_dat) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "sample_name")
mt_gauze_dat$seqcount <- sample_sums(phylo_gauze_dat)[mt_gauze_dat$sample_name]
```
### Sequencing depth
```{r}
ggplot(mt_gauze_dat, aes(seqcount, color = body_site_corrected, fill = body_site_corrected)) +
    geom_histogram(alpha = 0.1)+
    facet_grid(body_site_type~., scales = "free_y") +
    scale_x_continuous(trans = "log10", breaks = c(100, 1000, 10000)) +
    theme_bw(base_size = 10) + theme(legend.position = "none", aspect.ratio = 0.6) +
    labs(x = "Number of reads per sample", y = "Number of samples", title = "Comparison of sequencing depth in gauze sequencing and samples")
```

### Alpha diversity
```{r}
# mt_gauze_dat %>% group_by(body_site_type) %>% summarise(min(seqcount))
# rarefaction at 6K
phylo_gauze_dat_6k <- rarefy_even_depth(phylo_gauze_dat, sample.size = 6000, rngseed = 20, replace = F, trimOTUs = T)

mt_gauze_6k <- sample_data(phylo_gauze_dat_6k) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "sample_name")
mt_gauze_6k_samefam <- mt_gauze_6k %>% filter(familyid_unique %in% .$familyid_unique[.$mom_baby=="Gauze"])

phylo_gauze_dat_6k_samefam <- prune_samples(mt_gauze_6k_samefam$sample_name, phylo_gauze_dat_6k)

```

```{r}
phylo_gauze_6k_alpha <- estimate_richness(phylo_gauze_dat_6k, measures = c("Observed", "Shannon")) %>% rownames_to_column(var = "sample_name") %>% mutate(sample_name = gsub("^X", "", sample_name))

phylo_gauze_6k_alpha_dat <- merge(phylo_gauze_6k_alpha, mt_gauze_dat, by = 1, all.x = T) %>% pivot_longer(cols =c(Observed, Shannon), names_to = "variable", values_to = "value")

ggplot(phylo_gauze_6k_alpha_dat, aes(x = body_site_corrected, y = value, color = mom_baby)) +
    geom_violin(draw_quantiles = 0.5, scale = "width") +
    geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 1) +
    facet_wrap(.~variable, scales = "free_y") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 2) +
    labs(x = "", color = "", y = "Alpha diversity", title = "Comparison of alpha diversities", subtitle = "All samples from the 1st week")
```


```{r}
p <- plot_richness(phylo_gauze_dat_6k_samefam, measures = c("Observed", "Shannon"))
p_dat2 <- p$data
ggplot(p_dat2, aes(x = body_site_corrected, y = value, color = mom_baby)) +
    geom_violin(draw_quantiles = 0.5, scale = "width") +
    geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9), size = 1) +
    facet_wrap(.~variable, scales = "free_y") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 2) +
    labs(x = "", color = "", y = "Alpha diversity", title = "Comparison of alpha diversities", subtitle = "Samples from the same families the 1st week")
ggsave("../results/Gauze_alpha_6k_samefam.pdf", width = 7, useDingbats = F)
```
```{r}
p_dat2_stat <- p_dat2 %>% group_by(variable) %>% wilcox_test(value ~ body_site_corrected, paired = F, p.adjust.method = "fdr")
```

### beta diversity
```{r}
dist_jac <- distance(phylo_gauze_dat_6k_samefam, method = "jaccard", binary = T)
ord_jac <- ordinate(phylo_gauze_dat_6k_samefam, "PCoA", distance = dist_jac)

dist_bray <- distance(phylo_gauze_dat_6k_samefam, method = "bray")
ord_bray <- ordinate(phylo_gauze_dat_6k_samefam, "PCoA", distance = dist_bray)

p <- plot_ordination(phylo_gauze_dat_6k_samefam, ord_jac, color = "body_site_corrected", shape = "mom_baby")
p + scale_shape_manual(values = c(21, 17, 16)) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1) +
    labs(shape = "", color = "", title = "PCoA based on Jaccard ")

ggsave(filename = "../results/Gauze_beta_jac_6k_samefam.pdf", width = 5)

p <- plot_ordination(phylo_gauze_dat_6k_samefam, ord_bray, color = "body_site_corrected", shape = "mom_baby")
p + scale_shape_manual(values = c(21, 17, 16)) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1) +
    labs(shape = "", color = "", title = "PCoA based on Bray ")
ggsave(filename = "../results/Gauze_beta_bray_6k_samefam.pdf", width = 5)

```

# ASV
```{r}
# extract samples from the same families as the gauze samples
phylo_gauze_dat_samefam <- prune_samples(mt_gauze_6k_samefam$sample_name, phylo_gauze_dat)
ft_gauze_dat_samefam <- otu_table(phylo_gauze_dat_samefam) %>% as.matrix() %>% as.data.frame()
mt_gauze_dat_samefam <- sample_data(phylo_gauze_dat_samefam) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "sample_name")

mt_gauze <- mt_gauze_dat_samefam %>% filter(mom_baby=="Gauze")
mt_mm_lst <- mt_gauze_dat_samefam %>% filter(mom_baby=="Mom") %>% split(., .$body_site_corrected)

ft_gauze_l <- ft_gauze_dat_samefam[mt_gauze$sample_name] %>% rownames_to_column(var = "otu_id") %>% pivot_longer(names_to = "sample_name", values_to = "Count", -1) %>% filter(Count>0) %>% group_by(sample_name) %>% mutate(rela = Count/sum(Count)) %>% ungroup

asv_mm_lst <- lapply(mt_mm_lst, function(x){rowSums(ft_gauze_dat_samefam[x$sample_name]>0)})
asv_mm_lst <- lapply(seq_along(asv_mm_lst), function(x){asv_mm_lst[[x]][asv_mm_lst[[x]]>0.1*nrow(mt_mm_lst[[x]])] %>% names()})
names(asv_mm_lst) <- names(mt_mm_lst)

ss <- c("Feces", "Mouth", "Forearm", "Vagina", "Right_Areola", "Nose")
for(ff in ss){
    ft_gauze_l[[ff]] <- ft_gauze_l$otu_id %in% asv_mm_lst[[ff]]
}
ft_gauze_l <- ft_gauze_l %>% rowwise() %>% mutate(Gauze.only = !any(c_across(Feces:Nose))) %>% ungroup


ft_gauze_l_sum <- ft_gauze_l %>% mutate(across(Feces:Gauze.only, ~if_else(., rela, 0))) %>% group_by(sample_name) %>% summarise(across(Feces:Gauze.only, sum)) %>% ungroup %>% arrange(Gauze.only, Feces, Vagina) %>% mutate(sample_name = factor(sample_name, levels = unique(sample_name))) %>% pivot_longer(cols = Feces:Gauze.only, names_to = "bodysite", values_to = "rela")

ggplot(ft_gauze_l_sum, aes(x = factor(bodysite, levels = c("Gauze.only", "Feces", "Vagina", "Forearm", "Mouth", "Nose", "Right_Areola")), y = rela, fill = bodysite)) +
    geom_bar(position = "dodge", stat = "identity") +
    theme_bw(base_size = 10) + theme(axis.text.x = element_text(angle = 90, hjust = 1), aspect.ratio = 2, legend.position = "none") +
    facet_wrap(~sample_name, ncol = 5) +
    labs(x = "", y = "Relative abundance", fill = "", title = "Proportion of ASVs in gauze samples that can be found in only gauze or other maternal body sites")
```

```{r}
asv_gauze_lst <- lapply(list(mt_gauze), function(x){rowSums(ft_gauze_dat_samefam[x$sample_name]>0)})
asv_gauze_lst <- lapply(seq_along(asv_gauze_lst), function(x){asv_gauze_lst[[x]][asv_gauze_lst[[x]]>0.1*nrow(mt_gauze)] %>% names()})
names(asv_gauze_lst) <- "Gauze"


asv_lst <- c(lapply(asv_mm_lst, names), asv_gauze_lst)

venn.diagram(asv_lst[c(1:3, 6, 7)], imagetype = "png", category.names = names(asv_lst)[c(1:3, 6,7)], filename = "../results/venn_mm.png", output = T)
```



